<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HamzaEditz 2.0 - Music Player</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<!-- Feather Icons Script -->
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

<style>
  :root {
    --primary-gradient: linear-gradient(90deg, #8E2DE2, #4A00E0);
    --primary-color: #8E2DE2;
    --bg-dark: #0f0f12;
    --bg-light: #1f1f1f;
    --bg-lighter: #2a2a2a;
    --border-color: #333;
    --muted: #aaa;
  }

  html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    display:grid;
    place-items:center;
    background: var(--bg-dark);
    color:#e0e0e0;
    min-height:100vh;
  }
  
  i[data-feather] {
    width: 20px;
    height: 20px;
    stroke-width: 2.5;
  }
  .play-btn i[data-feather] {
    width: 24px;
    height: 24px;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  .spinning {
    animation: spin 1s linear infinite;
  }
  
  .music-player {
    width: 360px;
    background: var(--bg-light);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    box-sizing: border-box;
    user-select: none;
    -webkit-user-select: none;
  }

  .player-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:20px;
  }

  .song-art{
    width:56px;height:56px;border-radius:12px;
    background: var(--primary-gradient);
    display:grid;place-items:center;font-size:22px;color:#fff;overflow:hidden;
    flex-shrink: 0;
  }
  .song-art img{width:100%;height:100%;object-fit:cover;display:block;}

  .song-info{flex-grow:1;margin:0 14px;min-width:0;cursor:pointer;}
  .song-title{
    font-size:16px;font-weight:600;color:#fff;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .song-artist{font-size:13px;color:var(--muted);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

  .close-btn{font-size:16px;color:var(--muted);cursor:pointer;padding:8px;}
  .close-btn:hover{color:#fff;}
  .close-btn i[data-feather] { width: 22px; height: 22px; }

  .player-controls{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px; gap: 10px;}
  .control-btn{background:none;border:none;color:#e0e0e0;font-size:20px;cursor:pointer;padding:8px;border-radius: 50%; width: 44px; height: 44px; display:grid; place-items:center;}
  .control-btn:hover{color:#fff; background: var(--bg-lighter);}
  .control-btn:disabled { color: #555; cursor: not-allowed; }
  .control-btn:disabled:hover { background: none; }
  
  .play-btn{width:60px;height:60px;background:var(--primary-gradient);border-radius:50%;display:grid;place-items:center;font-size:22px;color:white;box-shadow:0 5px 15px rgba(142, 45, 226, 0.4);cursor:pointer; border: none;}

  .progress-area{display:flex;align-items:center;gap:12px;font-size:12px;color:var(--muted);margin-bottom:16px;}
  .progress-bar{flex-grow:1;height:6px;background-color:var(--bg-lighter);border-radius:3px;cursor:pointer;position:relative;}
  .progress-bar::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: -5px;
    bottom: -5px;
  }
  
  .progress-filled{height:100%;background:var(--primary-gradient);border-radius:3px;width:0%;}
  .progress-handle{
    width:12px;height:12px;background:var(--primary-color);border-radius:50%;
    position:absolute;top:50%;transform:translate(-50%,-50%);left:0%;
    z-index: 2;
  }

  .volume-area{display:flex;align-items:center;gap:12px;font-size:14px;color:var(--muted);}
  .volume-area i[data-feather] { width: 18px; height: 18px; }
  .volume-bar{flex-grow:1;height:6px;background-color:var(--bg-lighter);border-radius:3px;cursor:pointer;position:relative;}
  .volume-bar::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: -5px;
    bottom: -5px;
  }
  
  .volume-filled{height:100%;background:var(--primary-color);border-radius:3px;width:70%;}
  .volume-handle{
    width:14px;height:14px;background:var(--primary-color);border-radius:50%;
    position:absolute;top:50%;transform:translate(-50%,-50%);left:70%;
    z-index: 2;
  }
  .volume-number{font-size:12px;width:28px;text-align:right;color:var(--muted);}

  /* Search Popup */
  .popup-backdrop{
    position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;
    pointer-events:none;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
  }
  .popup-backdrop.show{display:flex;pointer-events:auto;}
  .popup{
    width:380px;max-width:94%;margin:24px;border-radius:12px;
    background:var(--bg-light);
    border: 1px solid var(--border-color);
    backdrop-filter: blur(8px);
    padding:14px;box-shadow:0 18px 48px rgba(0,0,0,0.6);
    transform:translateY(16px);opacity:0;transition:transform 230ms ease, opacity 230ms ease;
  }
  .popup.show{transform:translateY(0);opacity:1;}

  .popup .search-row{display:flex;gap:8px;margin-bottom:12px;}
  .popup input{
    flex:1;padding:10px 12px;border-radius:8px;
    border:1px solid var(--border-color);
    outline:none;background:var(--bg-lighter);color:#fff;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .popup input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 10px rgba(142, 45, 226, 0.5);
  }
  .popup button.search-btn{
    background:var(--primary-gradient);
    border:none;padding:0 14px;border-radius:8px;color:#fff;cursor:pointer; font-weight: 600;
  }
  .popup .hint{font-size:12px;color:var(--muted);margin-bottom:8px;}

  .results{max-height:320px;overflow:auto;padding-right:6px;border-top:1px solid var(--border-color);margin-top:8px;}
  .result-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;cursor:pointer;transition:background 150ms; margin-bottom:6px;}
  .result-item:hover{background:var(--bg-lighter);}
  .result-thumb{width:56px;height:56px;border-radius:8px;background:#222;overflow:hidden;flex-shrink:0;}
  .result-thumb img{width:100%;height:100%;object-fit:cover;display:block;}
  .result-meta{flex:1;min-width:0;}
  .r-title{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .r-sub{font-size:12px;color:var(--muted);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .r-duration{font-size:12px;color:var(--muted);margin-left:8px;flex-shrink:0;white-space:nowrap;}

  .loader-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    gap: 10px;
    color: var(--muted);
  }

  @media (max-width:420px){
    .music-player{width:94%;}
    .popup{width:94%;}
  }
</style>
</head>
<body>

  <div class="music-player" id="player">
    <div class="player-header">
      <div class="song-art" id="songArt">
        <i data-feather="music"></i>
      </div>

      <div class="song-info" id="songInfoBtn" title="Click to search">
        <div class="song-title" id="songTitle">Click to search songs</div>
        <div class="song-artist" id="songArtist">—</div>
      </div>

      <div class="close-btn" id="closeBtn" title="Close"><i data-feather="x"></i></div>
    </div>

    <div class="player-controls">
      <button class="control-btn prev-btn" id="prevBtn" title="Prev"><i data-feather="skip-back"></i></button>
      <button class="play-btn" id="playBtn" title="Play/Pause"><i data-feather="play" id="playIcon"></i></button>
      <button class="control-btn next-btn" id="nextBtn" title="Next"><i data-feather="skip-forward"></i></button>
      <button class="control-btn" id="downloadBtn" title="Download"><i data-feather="download"></i></button>
    </div>

    <div class="progress-area">
      <span class="time-current" id="timeCurrent">0:00</span>
      <div class="progress-bar" id="progressBar" title="Click to seek">
        <div class="progress-filled" id="progressFilled"></div>
        <div class="progress-handle" id="progressHandle"></div>
      </div>
      <span class="time-duration" id="timeDuration">0:00</span>
    </div>

    <div class="volume-area">
      <i data-feather="volume-1" id="volumeIcon"></i>
      <div class="volume-bar" id="volumeBar">
        <div class="volume-filled" id="volumeFilled" style="width:70%"></div>
        <div class="volume-handle" id="volumeHandle" style="left:70%"></div>
      </div>
      <span class="volume-number" id="volumeNumber">70</span>
    </div>

    <audio id="audio" crossorigin="anonymous"></audio>
  </div>

  <div class="popup-backdrop" id="popupBackdrop" aria-hidden="true">
    <div class="popup" id="popup">
      <div class="search-row">
        <input id="searchInput" placeholder="Search songs (type and press Enter)" autocomplete="off" />
        <button class="search-btn" id="searchBtn">Search</button>
      </div>
      <div class="hint">Results from Spotify (via your API) — tap a result to load & play</div>

      <div class="results" id="resultsList">
      </div>
    </div>
  </div>

<script>
// === FIX: Poora code DOMContentLoaded mein wrap karein ===
// Isse yeh ensure hoga ki script tab hi chale jab HTML poora load ho chuka ho.
document.addEventListener("DOMContentLoaded", () => {

  // Config & state
  const API_BASE = "https://okatsu-rolezapiiz.vercel.app/search/spotify?q=";
  const audio = document.getElementById("audio");
  let state = {
    playlist: [],
    currentIndex: -1,
    isPlaying: false
  };

  // Elements
  const songTitleEl = document.getElementById("songTitle");
  const songArtistEl = document.getElementById("songArtist");
  const songArtEl = document.getElementById("songArt");
  const songInfoBtn = document.getElementById("songInfoBtn");
  const playBtn = document.getElementById("playBtn");
  const playIcon = document.getElementById("playIcon");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const timeCurrentEl = document.getElementById("timeCurrent");
  const timeDurationEl = document.getElementById("timeDuration");
  const progressBar = document.getElementById("progressBar");
  const progressFilled = document.getElementById("progressFilled");
  const progressHandle = document.getElementById("progressHandle");
  const volumeIcon = document.getElementById("volumeIcon");
  const volumeBar = document.getElementById("volumeBar");
  const volumeFilled = document.getElementById("volumeFilled");
  const volumeHandle = document.getElementById("volumeHandle");
  const volumeNumber = document.getElementById("volumeNumber");

  const popupBackdrop = document.getElementById("popupBackdrop");
  const popup = document.getElementById("popup");
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const resultsList = document.getElementById("resultsList");
  
  // === FIX: Icon replace function ko robust banayein ===
  function replaceIcons() {
    if (typeof feather !== 'undefined') {
      feather.replace();
    } else {
      console.warn("Feather icons script not loaded.");
    }
  }

  // Utilities
  function formatTime(seconds){
    if (!seconds || isNaN(seconds)) return "0:00";
    const m = Math.floor(seconds/60);
    const s = Math.floor(seconds%60);
    return `${m}:${s<10? '0':''}${s}`;
  }
  function safeText(t){ return t ? t : ""; }

  // Player UI
  function updatePlayerUI(){
    const idx = state.currentIndex;
    if (idx < 0 || !state.playlist[idx]){
      songTitleEl.textContent = "Click to search songs";
      songArtistEl.textContent = "—";
      songArtEl.innerHTML = `<i data-feather="music"></i>`;
      timeCurrentEl.textContent = "0:00";
      timeDurationEl.textContent = "0:00";
      progressFilled.style.width = "0%";
      progressHandle.style.left = "0%";
      downloadBtn.disabled = true;
      replaceIcons();
      return;
    }
    const s = state.playlist[idx];
    songTitleEl.textContent = s.title;
    songArtistEl.textContent = s.artist;
    songArtEl.innerHTML = s.thumbnail ? `<img src="${s.thumbnail}" alt="art">` : `<i data-feather="music"></i>`;
    replaceIcons();
    timeCurrentEl.textContent = formatTime(audio.currentTime || 0);
  }

  // Playback
  function loadTrackAt(index, autoplay = true){
    if (!state.playlist[index]) return;
    state.currentIndex = index;
    const s = state.playlist[index];
    downloadBtn.disabled = false;
    audio.src = s.audio;
    audio.currentTime = 0;
    updatePlayerUI();
    if (autoplay){
      const p = audio.play();
      if (p && p.catch) {
        p.catch(()=>{ /* autoplay blocked */ });
      }
      state.isPlaying = true;
      playIcon.setAttribute("data-feather", "pause");
    } else {
      state.isPlaying = false;
      playIcon.setAttribute("data-feather", "play");
    }
    replaceIcons();
  }
  function playPauseToggle(){
    if (!audio.src) return;
    if (audio.paused){
      audio.play().catch(()=>{ /* ignore error */ });
      state.isPlaying = true;
      playIcon.setAttribute("data-feather", "pause");
    } else {
      audio.pause();
      state.isPlaying = false;
      playIcon.setAttribute("data-feather", "play");
    }
    replaceIcons();
  }
  function nextTrack(){
    if (state.playlist.length === 0) return;
    state.currentIndex = (state.currentIndex + 1) % state.playlist.length;
    loadTrackAt(state.currentIndex, true);
  }
  function prevTrack(){
    if (state.playlist.length === 0) return;
    state.currentIndex = (state.currentIndex - 1 + state.playlist.length) % state.playlist.length;
    loadTrackAt(state.currentIndex, true);
  }

  // Download
  async function downloadSong() {
    const currentTrack = state.playlist[state.currentIndex];
    if (!currentTrack || !currentTrack.audio) {
      alert("No song is loaded to download.");
      return;
    }
    downloadBtn.disabled = true;
    downloadBtn.innerHTML = '<i data-feather="loader" class="spinning"></i>';
    replaceIcons();
    try {
      // CORS proxy ka istemal karein
      const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
      const response = await fetch(proxyUrl + encodeURIComponent(currentTrack.audio));
      
      if (!response.ok) {
        throw new Error(`Failed to fetch audio: ${response.statusText}`);
      }
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `${currentTrack.title} - ${currentTrack.artist}.mp3`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    } catch (error) {
      console.error("Download Error:", error);
      alert("Could not download song. Trying fallback method...");
      // Fallback
      const a = document.createElement('a');
      a.href = currentTrack.audio;
      a.download = `${currentTrack.title} - ${currentTrack.artist}.mp3`;
      a.target = "_blank";
      a.click();
    } finally {
      downloadBtn.disabled = false;
      downloadBtn.innerHTML = '<i data-feather="download"></i>';
      replaceIcons();
    }
  }

  // Drag Handlers
  let isSeeking = false;
  let wasPlayingOnSeek = false;

  function setupDraggableBar(barEl, handleEl, onPercentChange, onDragStart, onDragEnd) {
    function getPercent(e) {
      const rect = barEl.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      if (clientX === undefined) return -1;
      let pct = (clientX - rect.left) / rect.width;
      return Math.max(0, Math.min(1, pct));
    }
    function handleMove(e) {
      if (!isSeeking) return;
      e.preventDefault();
      const pct = getPercent(e);
      if (pct !== -1) {
        onPercentChange(pct);
      }
    }
    function handleEnd(e) {
      if (!isSeeking) return;
      isSeeking = false;
      const rect = barEl.getBoundingClientRect();
      const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
      let pct;
      if (clientX === undefined) {
        pct = parseFloat(handleEl.style.left || 0) / 100;
      } else {
        pct = (clientX - rect.left) / rect.width;
        pct = Math.max(0, Math.min(1, pct));
      }
      if (onDragEnd) onDragEnd(pct);
      document.removeEventListener("mousemove", handleMove);
      document.removeEventListener("touchmove", handleMove);
      document.removeEventListener("mouseup", handleEnd);
      document.removeEventListener("touchend", handleEnd);
    }
    function handleStart(e) {
      e.preventDefault();
      isSeeking = true;
      if (onDragStart) onDragStart();
      const pct = getPercent(e);
      if (pct !== -1) {
        onPercentChange(pct);
      }
      document.addEventListener("mousemove", handleMove);
      document.addEventListener("touchmove", handleMove, { passive: false });
      document.addEventListener("mouseup", handleEnd);
      document.addEventListener("touchend", handleEnd);
    }
    handleEl.addEventListener("mousedown", handleStart);
    handleEl.addEventListener("touchstart", handleStart, { passive: false });
    barEl.addEventListener("mousedown", handleStart);
    barEl.addEventListener("touchstart", handleStart, { passive: false });
  }

  // Progress Bar Logic
  function setProgressUI(pct) {
    progressFilled.style.width = pct * 100 + "%";
    progressHandle.style.left = pct * 100 + "%";
    timeCurrentEl.textContent = formatTime((audio.duration || 0) * pct);
  }
  setupDraggableBar(
    progressBar, progressHandle,
    (pct) => { setProgressUI(pct); },
    () => {
      wasPlayingOnSeek = !audio.paused;
      if (wasPlayingOnSeek) { audio.pause(); }
    },
    (pct) => {
      if (audio.duration) {
        audio.currentTime = (audio.duration || 0) * pct;
      }
      if (wasPlayingOnSeek) { audio.play(); }
    }
  );
  audio.addEventListener("timeupdate", ()=>{
    if (isSeeking || !audio.duration || isNaN(audio.duration)) return;
    const percent = (audio.currentTime / audio.duration);
    progressFilled.style.width = percent * 100 + "%";
    progressHandle.style.left = percent * 100 + "%";
    timeCurrentEl.textContent = formatTime(audio.currentTime);
  });
  audio.addEventListener("loadedmetadata", ()=>{
    timeDurationEl.textContent = formatTime(audio.duration);
  });
  audio.addEventListener("ended", nextTrack);

  // Volume Bar Logic
  function setVolumeUI(pct) {
    audio.volume = pct;
    volumeFilled.style.width = pct * 100 + "%";
    volumeHandle.style.left = pct * 100 + "%";
    volumeNumber.textContent = Math.round(pct * 100);
    // Volume icon change
    if (pct === 0) {
      volumeIcon.setAttribute("data-feather", "volume-x");
    } else if (pct < 0.5) {
      volumeIcon.setAttribute("data-feather", "volume-1");
    } else {
      volumeIcon.setAttribute("data-feather", "volume-2");
    }
    replaceIcons();
  }
  setupDraggableBar(
    volumeBar, volumeHandle,
    (pct) => { setVolumeUI(pct); }
  );
  setVolumeUI(0.70); // Default volume

  // Search Popup
  songInfoBtn.addEventListener("click", ()=>{
    popupBackdrop.classList.add("show");
    popup.classList.add("show");
    resultsList.innerHTML = "";
    searchInput.focus();
  });
  popupBackdrop.addEventListener("click", (e)=>{
    if (e.target === popupBackdrop){ closePopup(); }
  });
  function closePopup(){
    popupBackdrop.classList.remove("show");
    popup.classList.remove("show");
  }

  // Fetch Search
  async function doSearch(query){
    if (!query) return;
    resultsList.innerHTML = `<div class="l